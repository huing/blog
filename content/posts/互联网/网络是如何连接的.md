---
title: "网络是如何连接的"
date: 2024-09-03T06:45:36+08:00
draft: false
tags: ["互联网"]
---

## 网络是如何连接的

### 浏览器处理流程

当我们在浏览器中输入一个 URL(如www.example.com)后,浏览器会经过以下步骤:

1. **解析 URL**

   - 识别协议(http/https)
   - 识别域名(example.com)
   - 识别资源路径(/)

2. **DNS 解析过程**

   - 首先检查浏览器 DNS 缓存
   - 检查操作系统 DNS 缓存
   - 检查路由器缓存
   - 向 ISP 的 DNS 服务器发起递归查询
   - 获取目标服务器的 IP 地址

3. **建立连接**

   - 与目标服务器建立 TCP 连接(三次握手)
   - 如果是 HTTPS,还需要进行 TLS 握手

4. **发送 HTTP 请求**

   - 浏览器构建 HTTP 请求报文
   - 通过网络发送到服务器

5. **浏览器渲染过程**
   - 解析 HTML 构建 DOM 树(DOM Tree)
   - 解析 CSS 构建 CSSOM(CSS Object Model)
   - 合并 DOM 和 CSSOM 构建渲染树(Render Tree)
   - 布局(Layout):计算每个节点的几何信息
   - 绘制(Painting):将渲染树绘制到屏幕上

### DNS (Domain Name System) 原理

DNS 是一个分布式数据库,主要功能是将域名转换为 IP 地址。解析过程如下:

1. 本地 DNS 缓存查询
2. 递归 DNS 服务器查询
3. 根域名服务器查询
4. 顶级域名服务器查询
5. 权威 DNS 服务器查询

#### DNS 记录类型

DNS 系统中最常用的两种记录类型是 A 记录和 CNAME 记录：

1. **A 记录 (Address Record)**

   - 直接将域名指向一个 IPv4 地址
   - 例如：

     ```js
     blog.example.com.     A        185.31.17.133
     ```

2. **CNAME 记录 (Canonical Name)**

   - 将一个域名指向另一个域名
   - 可以指向另一个 CNAME 记录或 A 记录
   - 继承目标域名的完整解析链
   - 示例：

     ```js
     blog.example.com.      CNAME   cdn.example.com.
     cdn.example.com.       CNAME   cdn.provider.net.
     cdn.provider.net.      A       185.31.17.133
     ```

#### 使用场景

- A 记录：当你需要将域名直接指向 IP 地址时使用
- CNAME 记录：当你需要将域名指向另一个域名时使用，常用于 CDN 服务或者需要动态改变目标服务器 IP 的场景

### IP (Internet Protocol) 寻址

**IP 是网络层协议，IP 地址是一串数字**

IP 协议负责:

- 为网络中的设备分配唯一的地址
- 数据包的路由和转发
- 处理数据包的分片和重组

### ISP (Internet Service Provider)

互联网服务提供商

- 为个人和企业提供互联网接入服务的公司或组织
- 例如：中国电信、中国联通、中国移动等
- 主要提供宽带接入、域名解析、电子邮件等基础互联网服务

### NSP (Network Service Provider)

网络服务提供商

- 主要为 ISP 提供网络基础设施和骨干网络服务
- 运营和维护大规模的网络基础设施
- 负责处理跨区域、跨国的网络通信

### TCP (Transmission Control Protocol)

TCP 是一个可靠的传输层协议，通过三次握手建立连接，确保数据传输的可靠性。

#### TCP 三次握手过程

1. **第一步：SYN (同步序列编号)**

   - 客户端发送 SYN 包到服务器
   - 设置 SYN 标志位为 1
   - 包含一个随机的序列号
   - ACK 标志位为 0

2. **第二步：SYN-ACK (同步序列编号确认)**

   - 服务器收到 SYN 后，发送 SYN-ACK 包
   - 设置 SYN 和 ACK 标志位都为 1
   - 确认客户端的序列号
   - 服务器也生成自己的序列号

3. **第三步：ACK (确认)**
   - 客户端收到 SYN-ACK 后，发送 ACK 包
   - 设置 ACK 标志位为 1
   - 确认服务器的序列号
   - TCP 连接正式建立

#### TCP 连接的特点

- **可靠性**：通过确认和重传机制确保数据可靠传输
- **全双工通信**：建立连接后，双方可以同时收发数据
- **面向连接**：传输数据前必须先建立连接
- **流量控制**：通过窗口大小控制数据传输速率

#### 常见的 TCP 应用协议

- HTTP/HTTPS
- FTP（文件传输）
- SMTP（邮件发送）
- SSH（安全 shell）
- IMAP/POP3（邮件接收）

#### TCP 连接释放

断开连接时也需要经过类似的握手过程：

1. 客户端发送 FIN 请求断开连接
2. 服务器回复 FIN+ACK
3. 客户端确认，发送 ACK

### 网络分层模型

网络通信采用分层的结构，最常见的是 OSI 七层模型，从底层到顶层分别是：

#### 1. 物理层 (Physical Layer)

- 负责比特流的传输
- 定义物理介质、接口和规范
- 处理原始的电信号、光信号等物理量

#### 2. 数据链路层 (Data Link Layer)

- 负责节点之间的数据传输
- 差错检测和控制
- 常见协议：
  - MAC (媒体访问控制)
  - ARP (地址解析协议)
  - PPP (点对点协议)

#### 3. 网络层 (Network Layer)

- 负责数据包的路由和转发
- 主要协议：
  - IP (网际协议)
  - ICMP (互联网控制消息协议)
  - IPsec (互联网安全协议)
- 处理网络地址、路由选择

#### 4. 传输层 (Transport Layer)

- 提供端到端的通信服务
- 负责数据的分段、传输、流控和差错控制
- 主要协议：
  - TCP (传输控制协议)：可靠、面向连接
  - UDP (用户数据报协议)：不可靠、无连接
  - SCTP (流控制传输协议)
  - QUIC (快速 UDP 网络连接)

#### 5. 会话层 (Session Layer)

- 建立、管理和终止会话
- 提供对话控制和同步功能
- 常见协议：
  - NetBIOS
  - RPC (远程过程调用)

#### 6. 表示层 (Presentation Layer)

- 数据格式转换和加密
- 负责数据的编码、压缩和加密
- 常见协议：
  - TLS/SSL
  - ASCII
  - JPEG、MPEG 等

#### 7. 应用层 (Application Layer)

- 为应用程序提供网络服务
- 直接面向用户的接口
- 常见协议：
  - HTTP/HTTPS (网页访问)
  - FTP (文件传输)
  - SMTP (邮件发送)
  - DNS (域名解析)
  - SSH (安全 shell)

#### 数据封装过程

在数据传输过程中，数据在各层之间传递时会经过封装和解封装：

1. 应用层数据
2. 加入传输层头部（TCP/UDP 头）
3. 加入网络层头部（IP 头）
4. 加入数据链路层头部和尾部
5. 转换为物理层的比特流传输

每一层都为上一层提供服务，同时使用下一层提供的服务，形成了一个完整的网络通信体系。

TODO 网络分层模型是什么时候参与到浏览器请求的过程中的
