---
title: "å¯¹è±¡"
date: 2022-09-04T12:37:25+08:00
draft: false
categories: ["js"]
---

## Map ç±»å‹

### Map

```ts
// âœ… Initialize Map from Array
// ğŸ‘‡ï¸ const map1: Map<string, string>
const map1: Map<string, string> = new Map([
  ["name", "Tom"],
  ["country", "Chile"],
]);

// ğŸ‘‡ï¸ {'name' => 'Tom', 'country' => 'Chile'}
console.log(map1);

// âœ… Initialize Map from Object
const obj = { name: "Tom", country: "Chile" };
const map2 = new Map<string, string>(Object.entries(obj));

// ğŸ‘‡ï¸ {'name' => 'Tom', 'country' => 'Chile'}
console.log(map2);
```

### objects vs maps

- æ„å¤–çš„é”®

  - map: æ˜¾å¼æ’å…¥çš„
  - object: åŸå‹é“¾ä¸Šçš„é”®å

- é”®çš„ç±»å‹
  - map: ä»»æ„å€¼ï¼ŒåŒ…æ‹¬å‡½æ•°ã€å¯¹è±¡æˆ–ä»»æ„åŸºæœ¬ç±»å‹
  - object: å¿…é¡»æ˜¯ä¸€ä¸ª String æˆ–æ˜¯ Symbol

## åœ¨ JavaScript ä¸­åˆ›å»ºä¸å¯ä¿®æ”¹çš„å¯¹è±¡æ–¹æ³•

åœ¨ JavaScript ä¸­ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥åˆ›å»ºä¸å¯ä¿®æ”¹çš„å¯¹è±¡æ–¹æ³•ï¼š

### 1. ä½¿ç”¨ `Object.defineProperty()` æˆ– `Object.defineProperties()`

```javascript
const obj = {};

Object.defineProperty(obj, "immutableMethod", {
  value: function () {
    return "I can't be changed";
  },
  writable: false, // ä¸å¯å†™
  configurable: false, // ä¸å¯é…ç½®
});

// å°è¯•ä¿®æ”¹ä¼šé™é»˜å¤±è´¥ï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ¥é”™ï¼‰
obj.immutableMethod = function () {
  return "new function";
};
console.log(obj.immutableMethod()); // ä»ç„¶è¾“å‡º "I can't be changed"
```

### 2. ä½¿ç”¨ `Object.freeze()`

```javascript
const obj = {
  immutableMethod() {
    return "I can't be changed";
  },
};

Object.freeze(obj); // å†»ç»“æ•´ä¸ªå¯¹è±¡

// å°è¯•ä¿®æ”¹ä¼šé™é»˜å¤±è´¥ï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ¥é”™ï¼‰
obj.immutableMethod = function () {
  return "new function";
};
console.log(obj.immutableMethod()); // ä»ç„¶è¾“å‡ºåŸå§‹æ–¹æ³•
// Object.freeze() æ˜¯æµ…å†»ç»“ï¼ŒåµŒå¥—å¯¹è±¡ä»ç„¶å¯ä»¥è¢«ä¿®æ”¹
```

### 3. ä½¿ç”¨ ES6 çš„ Proxy

```javascript
const obj = {
  immutableMethod() {
    return "I can't be changed";
  },
};

const protectedObj = new Proxy(obj, {
  set(target, prop, value) {
    if (prop === "immutableMethod") {
      throw new Error(`Cannot modify ${prop} method`);
    }
    target[prop] = value;
    return true;
  },
});

// å°è¯•ä¿®æ”¹ä¼šæŠ›å‡ºé”™è¯¯
protectedObj.immutableMethod = function () {
  return "new function";
}; // Error
```

### 4. ä½¿ç”¨ç±»ä¸­çš„ getter å’Œé—­åŒ…

```javascript
class ImmutableClass {
  constructor() {
    const immutableMethod = () => "I can't be changed";

    Object.defineProperty(this, "immutableMethod", {
      get: () => immutableMethod,
      configurable: false,
    });
  }
}

const instance = new ImmutableClass();
instance.immutableMethod = function () {
  return "new function";
}; // æ— æ•ˆ
```

## æ‰‹å†™ä¸€ä¸ª CloneDeep

```js
const cloneDeep = (obj) => {
  // å¤„ç†åŸºæœ¬ç±»å‹å’Œ null
  if (obj === null || typeof obj !== "object") {
    return obj;
  }

  // å¤„ç†æ—¥æœŸå¯¹è±¡
  if (obj instanceof Date) {
    return new Date(obj.getTime());
  }

  // å¤„ç†æ­£åˆ™è¡¨è¾¾å¼
  if (obj instanceof RegExp) {
    return new RegExp(obj.source, obj.flags);
  }

  // å¤„ç†æ•°ç»„
  if (Array.isArray(obj)) {
    return obj.map((item) => cloneDeep(item));
  }

  // å¤„ç† Map
  if (obj instanceof Map) {
    const clonedMap = new Map();
    obj.forEach((value, key) => {
      clonedMap.set(cloneDeep(key), cloneDeep(value));
    });
    return clonedMap;
  }

  // å¤„ç† Set
  if (obj instanceof Set) {
    const clonedSet = new Set();
    obj.forEach((value) => {
      clonedSet.add(cloneDeep(value));
    });
    return clonedSet;
  }

  // å¤„ç†å¾ªç¯å¼•ç”¨
  const weakMap = new WeakMap();

  function deepClone(obj) {
    if (weakMap.has(obj)) {
      return weakMap.get(obj);
    }

    const cloned = Object.create(Object.getPrototypeOf(obj));
    weakMap.set(obj, cloned);

    // è·å–æ‰€æœ‰å±æ€§ï¼ŒåŒ…æ‹¬ä¸å¯æšä¸¾çš„å±æ€§
    const descriptors = Object.getOwnPropertyDescriptors(obj);

    // å¤åˆ¶æ‰€æœ‰å±æ€§æè¿°ç¬¦
    Object.defineProperties(
      cloned,
      Object.fromEntries(
        Object.entries(descriptors).map(([key, descriptor]) => [
          key,
          {
            ...descriptor,
            value:
              descriptor.value && typeof descriptor.value === "object"
                ? cloneDeep(descriptor.value)
                : descriptor.value,
          },
        ])
      )
    );

    return cloned;
  }

  return deepClone(obj);
};

// ä½¿ç”¨ç¤ºä¾‹
const example = {
  string: "Hello",
  number: 123,
  boolean: true,
  null: null,
  undefined: undefined,
  date: new Date(),
  regexp: /test/gi,
  array: [1, 2, { a: 3 }],
  map: new Map([["key", "value"]]),
  set: new Set([1, 2, 3]),
  nested: {
    a: 1,
    b: {
      c: 2,
    },
  },
};

// åˆ›å»ºå¾ªç¯å¼•ç”¨
example.self = example;

const cloned = cloneDeep(example);
```
